---
layout: page
title:  "80486"
date:   2017.07.26 15:51
categories: blog
---

Что надо сделать, чтобы собрать и запустить OL под 80486?

1. Ставим себе qemu

1. Тянем десятиметровый [ЧертовскиМаленькийЛинукс](http://www.damnsmalllinux.org/), в моем случае dsl-4.4.10.iso

1. Запускаем машинку  
   * Windows: `qemu-system-i386.exe -M pc -cpu 486 -cdrom Downloads\dsl-4.4.10.iso -redir tcp:2222::22`
   * Linux: ``qemu-system-i386 -M pc -cpu 486 -cdrom `pwd`/dsl-4.4.10.iso -net user,hostfwd=tcp:127.0.0.1:2222-:22 -net nic,model=e1000``

1. Ssh не работает, исправляем недоразумение
   * либо `dsl ssh` в качестве строки загрузки, либо
     * ~~`sudo su`~~
     * ~~`ssh-keygen -t rsa -b 2048 -C "me@mail.net"` в `/etc/ssh/ssh_host_rsa_key`~~
     * ~~`/etc/init.d/ssh stop`~~
     * `sudo /etc/init.d/ssh start`
   * `sudo passwd dsl`, задаем пароль - я задал dsl

1. добавляем в ~/.ssh/config, ибо алгоритмы устаревают
   ```
   Host 127.0.0.1
      KexAlgorithms +diffie-hellman-group1-sha1,diffie-hellman-group-exchange-sha1
      Ciphers +aes128-cbc
   ```

1. На хост системе ставим gcc 3.4 (гугл в помощь).  
   Для убунту, например, качаем и последовательно ставим
   * `http://old-releases.ubuntu.com/ubuntu/pool/universe/g/gcc-3.4/gcc-3.4-base_3.4.6-6ubuntu3_amd64.deb`
   * `http://old-releases.ubuntu.com/ubuntu/pool/universe/g/gcc-3.4/cpp-3.4_3.4.6-6ubuntu3_amd64.deb`
   * `http://old-releases.ubuntu.com/ubuntu/pool/universe/g/gcc-3.4/gcc-3.4_3.4.6-6ubuntu3_amd64.deb`

1. Один раз законнектимся ручками (чтобы ключик подхватился)
   * `ssh -p 2222 dsl@127.0.0.1`

1. Тянем себе нужные файлы с таргета
   * `sshpass -p "dsl"  scp -P 2222 dsl@127.0.0.1:/lib/libc-2.3.2.so .`
   * `sshpass -p "dsl"  scp -P 2222 dsl@127.0.0.1:/lib/libm-2.3.2.so .`
   * `sshpass -p "dsl"  scp -P 2222 dsl@127.0.0.1:/lib/ld-2.3.2.so .`
   * `sshpass -p "dsl"  scp -P 2222 dsl@127.0.0.1:/lib/libgcc_s.so.1 .`
   * `sshpass -p "dsl"  scp -P 2222 dsl@127.0.0.1:/usr/lib/libc_nonshared.a .`
   * `sshpass -p "dsl"  scp -P 2222 dsl@127.0.0.1:/usr/lib/crt1.o .`
   * чтобы потом не извращаться, `cp ld-2.3.2.so libd-2.3.2.so`

1. Теперь можно и собирать  
   ```bash
   gcc-3.4 -std=c99 -O2 -DNDEBUG -fno-exceptions -m32 -mtune=i486 \
      -DHAS_DLOPEN=0 -DSYSCALL_MEMFD=0 \
      src/olvm.c tmp/repl.c extensions/ffi.c \
      -L. -lc-2.3.2 -lm-2.3.2 -lgcc_s -ld-2.3.2 libc_nonshared.a \
      -o ol -DREPL=repl
   ```

1. Все, отправляем ol на девайс через ssh и тестим
`sshpass -p "dsl" scp -P 2222 ./ol dsl@127.0.0.1:/home/dsl/ol`

Все.